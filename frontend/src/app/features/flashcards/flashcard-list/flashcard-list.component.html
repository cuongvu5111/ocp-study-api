<div class="flashcard-list">
    <header class="page-header">
        <div>
            <h1>Flashcards</h1>
            <p>√în t·∫≠p v·ªõi ph∆∞∆°ng ph√°p Spaced Repetition</p>
        </div>
        <div class="header-actions">
            <a routerLink="/flashcards/review" class="btn btn--primary">
                <span class="material-icons-outlined">play_arrow</span>
                Review ngay ({{ dueCount() }})
            </a>
            <button class="btn btn--secondary" (click)="openCreateModal()">
                <span class="material-icons-outlined">add</span>
                T·∫°o m·ªõi
            </button>
        </div>
    </header>

    <!-- Stats -->
    <div class="stats-row">
        <div class="stat-box">
            <span class="stat-icon">üìö</span>
            <div class="stat-info">
                <span class="stat-value">{{ totalCards() }}</span>
                <span class="stat-label">T·ªïng s·ªë</span>
            </div>
        </div>
        <div class="stat-box">
            <span class="stat-icon">‚è∞</span>
            <div class="stat-info">
                <span class="stat-value">{{ dueCount() }}</span>
                <span class="stat-label">C·∫ßn √¥n</span>
            </div>
        </div>
        <div class="stat-box">
            <span class="stat-icon">‚úÖ</span>
            <div class="stat-info">
                <span class="stat-value">{{ masteredCount() }}</span>
                <span class="stat-label">ƒê√£ thu·ªôc</span>
            </div>
        </div>
    </div>

    <!-- Flashcards Grid -->
    @if (loading()) {
    <div class="loading-state">
        <div class="spinner"></div>
        <p>ƒêang t·∫£i flashcards...</p>
    </div>
    } @else if (flashcards().length === 0) {
    <div class="empty-state">
        <span class="material-icons-outlined">style</span>
        <p>Ch∆∞a c√≥ flashcard n√†o</p>
        <button class="btn btn--primary" (click)="openCreateModal()">
            <span class="material-icons-outlined">add</span>
            T·∫°o flashcard ƒë·∫ßu ti√™n
        </button>
    </div>
    } @else {
    <div class="cards-grid">
        @for (card of flashcards(); track card.id) {
        <div class="flashcard-item" (click)="viewCard(card)">
            <div class="card-topic">{{ card.topicName }}</div>
            <div class="card-front">{{ card.front }}</div>
            @if (card.codeExample) {
            <div class="card-code">
                <code>{{ card.codeExample.substring(0, 50) }}...</code>
            </div>
            }
            <div class="card-meta">
                <span title="S·ªë l·∫ßn review">
                    <span class="material-icons-outlined">refresh</span>
                    {{ card.reviewCount }}
                </span>
                <span title="Accuracy">
                    <span class="material-icons-outlined">check_circle</span>
                    {{ card.reviewCount > 0 ? Math.round(card.correctCount / card.reviewCount * 100) : 0 }}%
                </span>
            </div>
        </div>
        }
    </div>
    }

    <!-- Detail Modal -->
    @if (selectedCard()) {
    <div class="modal-overlay" (click)="closeDetailModal()">
        <div class="modal modal-detail" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <div>
                    <span class="card-topic-badge">{{ selectedCard()!.topicName }}</span>
                    <h2>Chi ti·∫øt Flashcard</h2>
                </div>
                <button class="btn-close" (click)="closeDetailModal()">
                    <span class="material-icons-outlined">close</span>
                </button>
            </div>

            <div class="modal-body">
                <div class="detail-section">
                    <h3>
                        <span class="material-icons-outlined">help_outline</span>
                        C√¢u h·ªèi
                    </h3>
                    <p class="detail-content">{{ selectedCard()!.front }}</p>
                </div>

                <div class="detail-section">
                    <h3>
                        <span class="material-icons-outlined">lightbulb</span>
                        C√¢u tr·∫£ l·ªùi
                    </h3>
                    <p class="detail-content">{{ selectedCard()!.back }}</p>
                </div>

                @if (selectedCard()!.codeExample) {
                <div class="detail-section">
                    <h3>
                        <span class="material-icons-outlined">code</span>
                        Code Example
                    </h3>
                    <pre class="code-block"><code>{{ selectedCard()!.codeExample }}</code></pre>
                </div>
                }

                <div class="detail-stats">
                    <div class="stat-item">
                        <span class="material-icons-outlined">refresh</span>
                        <span>{{ selectedCard()!.reviewCount }} l·∫ßn review</span>
                    </div>
                    <div class="stat-item">
                        <span class="material-icons-outlined">check_circle</span>
                        <span>{{ selectedCard()!.correctCount }} l·∫ßn ƒë√∫ng</span>
                    </div>
                    <div class="stat-item">
                        <span class="material-icons-outlined">calendar_today</span>
                        <span>{{ formatDate(selectedCard()!.createdAt) }}</span>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn--ghost" (click)="closeDetailModal()">
                    ƒê√≥ng
                </button>
            </div>
        </div>
    </div>
    }

    <!-- Create Modal -->
    @if (showCreateModal()) {
    <div class="modal-overlay" (click)="closeCreateModal()">
        <div class="modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h2>T·∫°o Flashcard M·ªõi</h2>
                <button class="btn-close" (click)="closeCreateModal()">
                    <span class="material-icons-outlined">close</span>
                </button>
            </div>

            <div class="modal-body">
                <form (ngSubmit)="submitFlashcard()" #flashcardForm="ngForm">
                    <!-- Topic Selection -->
                    <div class="form-group">
                        <label for="topicId">
                            Topic <span class="required">*</span>
                        </label>
                        <select id="topicId" name="topicId" [(ngModel)]="newFlashcard.topicId" required
                            class="form-control">
                            <option value="">-- Ch·ªçn topic --</option>
                            @for (topic of topics(); track topic.id) {
                            <option [value]="topic.id">{{ topic.icon }} {{ topic.name }}</option>
                            }
                        </select>
                    </div>

                    <!-- Front (Question) -->
                    <div class="form-group">
                        <label for="front">
                            C√¢u h·ªèi (Front) <span class="required">*</span>
                        </label>
                        <textarea id="front" name="front" [(ngModel)]="newFlashcard.front" required rows="3"
                            placeholder="VD: Functional Interface l√† g√¨?" class="form-control"></textarea>
                    </div>

                    <!-- Back (Answer) -->
                    <div class="form-group">
                        <label for="back">
                            C√¢u tr·∫£ l·ªùi (Back) <span class="required">*</span>
                        </label>
                        <textarea id="back" name="back" [(ngModel)]="newFlashcard.back" required rows="4"
                            placeholder="VD: Interface ch·ªâ c√≥ duy nh·∫•t 1 abstract method, c√≥ th·ªÉ c√≥ @FunctionalInterface annotation"
                            class="form-control"></textarea>
                    </div>

                    <!-- Code Example (Optional) -->
                    <div class="form-group">
                        <label for="codeExample">
                            Code Example (Optional)
                        </label>
                        <textarea id="codeExample" name="codeExample" [(ngModel)]="newFlashcard.codeExample" rows="5"
                            placeholder="@FunctionalInterface&#10;interface Calculator {&#10;  int calculate(int a, int b);&#10;}"
                            class="form-control code-input"></textarea>
                    </div>

                    <!-- Error Message -->
                    @if (errorMessage()) {
                    <div class="error-box">
                        <span class="material-icons-outlined">error</span>
                        {{ errorMessage() }}
                    </div>
                    }

                    <!-- Actions -->
                    <div class="modal-footer">
                        <button type="button" class="btn btn--ghost" (click)="closeCreateModal()">
                            H·ªßy
                        </button>
                        <button type="submit" class="btn btn--primary"
                            [disabled]="!flashcardForm.valid || submitting()">
                            @if (submitting()) {
                            <span class="spinner-sm"></span>
                            ƒêang l∆∞u...
                            } @else {
                            <span class="material-icons-outlined">save</span>
                            L∆∞u Flashcard
                            }
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    }
</div>